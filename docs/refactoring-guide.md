# WhaSub 코드 리팩토링 가이드

## 개요

이 문서는 WhaSub 확장 프로그램의 코드 리팩토링 과정과 표준을 정의합니다. 리팩토링의 목적은 코드의 가독성, 유지보수성, 성능을 향상시키고 버그를 줄이는 것입니다.

## 리팩토링 절차

각 리팩토링 작업은 다음 단계를 따릅니다:

1. **문제 식별**: 개선이 필요한 부분을 식별합니다.
2. **해결 방안 설계**: 문제 해결을 위한 리팩토링 방안을 설계합니다.
3. **구현**: 설계에 따라 코드를 수정합니다.
4. **테스트**: 변경 사항이 기존 기능을 손상시키지 않는지 확인합니다.
5. **문서화**: 변경 사항을 이 문서에 기록합니다.

## 리팩토링 기록

### [날짜: YYYY-MM-DD] 파일: [파일명]

#### 문제 식별
- 식별된 문제에 대한 설명

#### 해결 방안
- 적용된 해결 방안 설명

#### 구현 내용
- 변경된 코드의 주요 내용 요약
- 적용된 디자인 패턴이나 기법

#### 테스트 결과
- 테스트 방법 및 결과
- 확인된 개선 사항

---

### [2024-03-29] 파일: background.js

#### 문제 식별
- `chrome.tabs.sendMessage` 함수 호출 시 Promise 기반 `.catch()` 메서드를 사용하여 에러 처리를 시도하나, Chrome 확장 프로그램 API는 콜백 기반으로 동작하여 `TypeError: Error in invocation of tabs.sendMessage` 오류 발생
- 여러 곳에서 비슷한 패턴으로 에러가 발생하고 있음

#### 해결 방안
- `.catch()` 메서드 대신 콜백 함수를 사용하여 `chrome.runtime.lastError`를 확인하는 방식으로 에러 처리 로직 변경
- 모든 `chrome.tabs.sendMessage` 호출 부분을 일관된 방식으로 수정

#### 구현 내용
- 다음과 같은 패턴으로 모든 해당 함수 호출 수정:
```javascript
chrome.tabs.sendMessage(tabId, {
  // 메시지 내용
}, () => {
  if (chrome.runtime.lastError) {
    console.warn('[Whatsub] 메시지 전송 실패 (무시됨):', chrome.runtime.lastError);
  }
});
```

#### 테스트 결과
- `TypeError: Error in invocation of tabs.sendMessage` 오류 해결
- 메시지 전송 실패 시에도 애플리케이션이 중단되지 않고 적절한 로깅 수행

---

### [2024-03-29] 파일: services/logger.js

#### 문제 식별
- 기존 `debugLogger.js`는 기능이 제한적이고 일관성이 부족함
- 로그 레벨 구분이 없어 개발/프로덕션 환경에 따른 로깅 제어가 어려움
- 로그 저장 및 검색 기능이 없어 디버깅이 어려움

#### 해결 방안
- 전체 애플리케이션에서 사용할 중앙화된 로깅 서비스 구현
- 로그 레벨(DEBUG, INFO, WARN, ERROR)을 지원하는 체계적인 로깅 시스템 설계
- 로그 저장, 그룹화, 검색 기능 추가

#### 구현 내용
- 로그 레벨에 따른 필터링 기능 구현
- 개발/프로덕션 모드 전환 기능 추가
- 로그 히스토리 저장 및 관리 기능 구현
- 콘솔, 스토리지, 원격 서버 등 다양한 로깅 대상 지원

#### 테스트 결과
- 개발 모드에서 상세한 로그 확인 가능
- 프로덕션 모드에서는 중요 로그만 표시되어 성능 개선
- 로그 그룹화로 가독성 향상

---

### [2024-03-29] 파일: services/chrome-api.js

#### 문제 식별
- Chrome API는 콜백 기반으로 구현되어 있어 비동기 코드의 가독성과 에러 처리가 어려움
- 반복적인 에러 처리 코드가 프로젝트 전반에 중복됨
- 타임아웃 처리가 일관적이지 않음

#### 해결 방안
- Chrome API를 Promise 기반으로 래핑하는 유틸리티 모듈 구현
- 모든 API 호출에 일관된 에러 처리 패턴 적용
- 타임아웃 처리 표준화

#### 구현 내용
- Chrome 확장 프로그램의 주요 API를 Promise로 래핑:
  - `chrome.tabs.sendMessage`
  - `chrome.runtime.sendMessage`
  - `chrome.storage.local.get/set`
  - `chrome.storage.sync.get/set`
  - `chrome.tabs.query`
  - `chrome.identity.getAuthToken`
- 에러 처리와 타임아웃 로직을 일관되게 적용
- 안전한 API 호출 함수(`sendTabMessageSafe`) 추가

#### 테스트 결과
- `async/await` 패턴 사용으로 코드 가독성 향상
- 일관된 에러 처리로 안정성 개선
- 타임아웃 처리로 무한 대기 상태 방지

---

### [2024-03-29] 파일: services/auth-service.js

#### 문제 식별
- 인증 관련 코드가 `background.js`에 직접 구현되어 있어 모듈화되지 않음
- 인증 상태 관리가 전역 변수에 의존하여 예측 불가능한 동작 발생 가능
- 하위 호환성을 위한 코드가 명확하게 구분되지 않음

#### 해결 방안
- 인증 관련 코드를 별도의 서비스 모듈로 분리
- 옵저버 패턴을 사용하여 인증 상태 변경 이벤트 구독 메커니즘 구현
- 하위 호환성 코드를 명확히 구분하고 문서화

#### 구현 내용
- 인증 관련 모든 기능을 포함하는 `authService` 모듈 구현:
  - Google 로그인/로그아웃
  - 인증 상태 확인 및 관리
  - 토큰 유효성 검증
  - 인증 데이터 저장 및 불러오기
- 옵저버 패턴을 사용한 인증 상태 변경 구독 기능 구현
- 일관된 에러 처리 및 로깅

#### 테스트 결과
- 인증 관련 코드의 응집도 향상
- 인증 상태 변경 시 다른 모듈에 일관된 알림 제공
- 코드 재사용성 및 테스트 용이성 향상

---

### [2024-03-29] 파일: services/message-service.js

#### 문제 식별
- 메시지 처리 로직이 `background.js`에 직접 구현되어 있어 모듈화되지 않음
- 메시지 핸들러 등록과 관리가 어려움
- 초기화 중 수신된 메시지 처리 로직이 복잡하고 일관성 없음
- 메시지 송수신 시 에러 처리가 불충분하고 타임아웃 처리가 필요함

#### 해결 방안
- 메시지 처리 로직을 별도의 서비스 모듈로 분리
- 핸들러 등록 및 해제 메커니즘 구현
- 대기 메시지 큐 시스템 개선
- 메시지 관련 상수 정의 및 중앙화

#### 구현 내용
- 메시지 핸들러 등록 및 해제 기능 구현:
  - 액션별 핸들러를 Map에 저장
  - 핸들러 등록 시 해제 함수 반환
- 메시지 전송 유틸리티 함수 제공:
  - 탭에 메시지 전송
  - 백그라운드에 메시지 전송
  - 현재 활성 탭에 메시지 전송
  - 안전한 메시지 전송(실패해도 오류 발생 안함)
- 대기 메시지 큐 시스템 구현:
  - 초기화 중 수신된 메시지 저장
  - 초기화 완료 후 순차적 처리
- 모든 메시지 액션 상수 정의 및 중앙화

#### 테스트 결과
- 메시지 처리 로직의 모듈화로 코드 가독성 향상
- 핸들러 관리 용이성 개선
- 초기화 중 메시지 처리 안정성 향상
- 에러 처리 및 로깅 일관성 향상

## 코드 스타일 가이드

### 명명 규칙
- **변수/함수**: camelCase (예: `getUserData`, `isActive`)
- **클래스**: PascalCase (예: `AudioService`, `SubtitleManager`)
- **상수**: UPPER_SNAKE_CASE (예: `MAX_RETRY_COUNT`, `API_BASE_URL`)
- **프라이빗 필드/메서드**: 언더스코어 접두사 (예: `_privateMethod`, `_internalState`)

### 파일 구조
- 관련 기능은 동일한 모듈/파일에 그룹화
- 각 파일은 하나의 주요 책임을 가짐
- 파일 상단에 목적과 책임을 설명하는 주석 포함

### 코드 포맷팅
- 들여쓰기: 2칸
- 문자열: 작은따옴표(`'`) 우선 사용
- 세미콜론 사용
- 최대 줄 길이: 100자

### 주석 작성
- 복잡한 로직이나 비즈니스 규칙에 주석 추가
- JSDoc 스타일 주석 사용
- TODO, FIXME 주석에는 해결 방안이나 담당자 정보 포함

## 리팩토링 우선순위

1. **버그 수정**: 사용자 경험에 직접적인 영향을 미치는 버그
2. **성능 개선**: 로딩 시간이나 반응성 향상
3. **코드 구조화**: 모듈화 및 관심사 분리
4. **테스트 코드 추가**: 자동화된 테스트 추가
5. **문서화 개선**: 코드 주석 및 문서 업데이트

## 리팩토링 목표

- [x] 일관된 에러 처리 전략 구현
- [x] 로깅 서비스 개선
- [x] Chrome API 래핑 유틸리티 구현
- [x] 인증 서비스 모듈화
- [x] 메시지 처리 서비스 구현
- [ ] 자막 서비스 모듈화
- [ ] 오디오 캡처 서비스 모듈화
- [ ] 상태 관리 개선
- [ ] 코드 중복 제거
- [ ] 테스트 커버리지 향상

---

### [2024-04-02] 파일: services/message-service.js, popup.js, background.js

#### 문제 식별
- 메시지 응답 타임아웃 문제: 확장 프로그램의 팝업과 백그라운드 스크립트 간 통신에서 응답 시간이 오래 걸리면 타임아웃이 발생
- 인증 상태 확인(`checkAuth`) 기능에서 특히 자주 타임아웃 오류 발생
- 토큰 유효성 검증 시 네트워크 지연으로 인해 응답이 늦어지는 경우 전체 프로세스가 지연됨
- 타임아웃 발생 시 폴백 메커니즘 부재

#### 해결 방안
- 메시지 서비스의 `sendToBackground` 함수 개선:
  - 타임아웃 시간을 5초에서 10초로 증가
  - 명시적인 타임아웃 처리 로직 추가
- 팝업의 `sendMessage` 함수 개선:
  - 메시지 서비스가 있는 경우 이를 활용하도록 변경
  - 타임아웃 시간 10초로 증가
- 인증 상태 확인 로직 최적화:
  - 인증 정보가 없는 경우 빠르게 처리
  - 토큰 유효성 검증에 5초 타임아웃 추가
  - 유효성 검증 타임아웃 시 일단 유효하다고 가정하는 폴백 로직 추가

#### 구현 내용
- `services/message-service.js`의 `sendToBackground` 함수 수정:
  - Promise 기반 타임아웃 처리 추가
  - 오류 타입 분류 및 상세 로깅 개선
- `popup.js`의 `sendMessage` 함수 개선:
  - 메시지 서비스 지원 추가 (`window.whatsub.messageService` 사용)
  - 호환성을 위한 직접 메시지 전송 폴백 유지
- `background.js`의 `checkAuth` 함수 최적화:
  - 인증 정보 없는 경우 조기 반환 로직 추가
  - `Promise.race`를 사용한 토큰 유효성 검증 타임아웃 처리
  - 타임아웃 발생 시 사용자 경험을 위해 토큰이 유효하다고 가정

#### 테스트 결과
- 타임아웃 오류 발생 빈도 감소
- 인증 상태 확인 속도 향상
- 네트워크 지연 상황에서도 UI 반응성 향상
- 메시지 처리 실패 시 더 명확한 오류 메시지 제공

---

### [2024-04-02] 파일: background.js, services/chrome-api.js, popup.js

#### 문제 식별
- `chrome.tabs.sendMessage` 호출 시 "TypeError: Error in invocation of tabs.sendMessage(integer tabId, any message, optional object options, optional function callback): No matching signature" 오류 발생
- 음성 인식 시작 및 자막 전송 과정에서 탭 간 통신이 실패하는 문제 발생
- 콜백 함수 매개변수 형식이 잘못되어 API 호출 실패

#### 해결 방안
- `chrome.tabs.sendMessage` 호출 방식을 Chrome API 문서에 맞게 수정
- 모든 콜백 함수를 화살표 함수 대신 명명된 함수 형식으로 변경
- 콜백 함수에 response 매개변수 추가
- 올바른 에러 처리를 위한 try/catch 블록 추가

#### 구현 내용
- `background.js` 내 `startSimulatedRecognition` 함수 수정:
  - `chrome.tabs.sendMessage` 호출 방식을 수정하여 올바른 매개변수 형식 적용
  - 함수 호출 주변에 try/catch 블록 추가
- `services/chrome-api.js`의 `sendTabMessageSafe` 함수 수정:
  - 콜백 함수에 `response` 매개변수 추가
  - 매개변수 구조 명확히 정의
- `popup.js`의 `toggleSubtitleFilter` 함수 개선:
  - 탭 ID 유효성 검사 로직 강화
  - 로깅 개선으로 디버깅 용이성 향상
  - 에러 메시지 명확화

#### 테스트 결과
- "No matching signature" 오류 해결
- 음성 인식 시작 및 자막 전송 정상 작동
- 탭 간 통신 안정성 향상
- 더 유익한 디버그 정보 제공으로 문제 해결 용이 