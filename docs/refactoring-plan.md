# WhaSub 확장 프로그램 리팩토링 계획

## 현재 상태 분석

### 문제점

1. **코드 분산**: 관련 기능이 여러 파일에 분산되어 있습니다.
2. **중복 코드**: 유사한 기능의 코드가 여러 곳에서 반복됩니다.
3. **일관성 부족**: 에러 처리, 로깅, 비동기 패턴 등이 일관되지 않습니다.
4. **모듈화 부족**: 기능이 적절히 모듈화되어 있지 않아 유지보수가 어렵습니다.
5. **상태 관리 복잡성**: 전역 상태 관리가 복잡하고 예측 불가능합니다.

### 현재 구조

- **background.js**: 모든 주요 기능(인증, 메시지 처리, 오디오 캡처, 자막 처리 등)이 한 파일에 집중됨
- **services/**: 여러 서비스 파일이 있으나 제대로 활용되지 않음
- **popup.js**: UI 관련 로직과 비즈니스 로직이 혼재됨

## 리팩토링 목표

1. **모듈화**: 관련 기능을 논리적인 모듈로 분리
2. **의존성 감소**: 모듈 간 의존성 최소화
3. **일관된 코딩 패턴**: 특히 비동기 처리와 에러 처리
4. **테스트 용이성**: 단위 테스트를 쉽게 작성할 수 있는 구조
5. **확장성**: 새로운 기능 추가가 용이한 구조
6. **성능 최적화**: 불필요한 연산 제거 및 메모리 관리 개선

## 리팩토링 단계

### 1단계: 파일 구조 재조직 (현재 진행 중)

- [x] 리팩토링 문서 템플릿 생성
- [ ] 현재 파일 구조 분석 및 정리
- [ ] 서비스 모듈 활용 방안 수립
- [ ] 새로운 파일 구조 설계

### 2단계: 핵심 기능 모듈화

- [ ] **인증 서비스**: 로그인, 로그아웃, 인증 상태 관리
- [ ] **메시지 서비스**: 메시지 라우팅 및 처리
- [ ] **오디오 서비스**: 오디오 캡처 및 처리
- [ ] **자막 서비스**: 자막 생성, 표시, 관리
- [ ] **스토리지 서비스**: 데이터 저장 및 관리
- [ ] **로깅 서비스**: 일관된 로깅 메커니즘

### 3단계: 상태 관리 개선

- [ ] 전역 상태 관리자 구현
- [ ] 상태 변경 이벤트 시스템 구현
- [ ] 개별 모듈의 상태 관리 독립성 확보

### 4단계: 오류 처리 표준화

- [x] Chrome API 호출 패턴 표준화
- [ ] 에러 타입 정의 및 분류
- [ ] 에러 로깅 및 보고 메커니즘 구현
- [ ] 사용자 친화적인 에러 메시지 표시

### 5단계: 테스트 코드 작성

- [ ] 단위 테스트 프레임워크 설정
- [ ] 핵심 모듈에 대한 테스트 케이스 작성
- [ ] 통합 테스트 구현
- [ ] 자동화된 테스트 파이프라인 구축

## 리팩토링 우선순위

1. **에러 처리 개선**: 사용자 경험에 직접적인 영향을 미치는 오류
2. **인증 모듈화**: 로그인 관련 기능 안정화
3. **메시지 처리 개선**: 모듈 간 통신의 핵심
4. **자막 서비스 최적화**: 핵심 기능인 자막 관련 처리
5. **오디오 캡처 모듈화**: 음성 인식 관련 기능

## 기술적 결정사항

### 채택할 패턴

- **모듈 패턴**: 관련 기능을 논리적 단위로 그룹화
- **옵저버 패턴**: 상태 변경 시 관심 있는 컴포넌트에 알림
- **프록시 패턴**: Chrome API와의 인터페이스 추상화
- **팩토리 패턴**: 유사한 객체 생성 로직 통합

### 비동기 처리 방식

- **Promise 기반**: 모든 비동기 로직은 Promise 반환
- **async/await**: 가독성을 위해 적극 활용
- **Chrome API 래핑**: 콜백 기반 API를 Promise 기반으로 래핑

### 에러 처리 전략

- **구조화된 에러 객체**: 타입, 메시지, 코드 등 포함
- **중앙화된 에러 로깅**: 모든 에러는 중앙 로거로 전송
- **우아한 실패**: 가능한 경우 기능 일부만 비활성화

## 구현 일정

- **1단계**: 2024-03-29 ~ 2024-04-01
- **2단계**: 2024-04-02 ~ 2024-04-08
- **3단계**: 2024-04-09 ~ 2024-04-12
- **4단계**: 2024-04-13 ~ 2024-04-15
- **5단계**: 2024-04-16 ~ 2024-04-20 